<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
		/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta
			name="apple-mobile-web-app-status-bar-style"
			content="black-translucent"
		/>
		<meta name="theme-color" content="#111827" />
		<title>MarketMind</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
		<script>
			tailwind.config = {
				theme: {
					extend: {
						colors: { gray: { 850: "#1f2937", 900: "#111827" } },
					},
				},
			};
		</script>
		<style>
			body {
				overscroll-behavior-y: none;
				-webkit-tap-highlight-color: transparent;
			}
			.hide-scrollbar::-webkit-scrollbar {
				display: none;
			}
			.hide-scrollbar {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
			.chart-container {
				position: relative;
				width: 100%;
				max-width: 600px;
				height: 180px;
				margin: 0 auto;
			}
			@media (min-width: 768px) {
				.chart-container {
					height: 220px;
				}
			}
			.glass-nav {
				background: rgba(17, 24, 39, 0.85);
				backdrop-filter: blur(12px);
				-webkit-backdrop-filter: blur(12px);
				border-top: 1px solid rgba(55, 65, 81, 0.5);
			}
		</style>
		<!-- Chosen Palette: Dark Mode Financial (Deep Gray #111827, Surface Gray #1F2937, Bull Green #10B981, Bear Red #EF4444, Accent Blue #3B82F6) -->
		<!-- Application Structure Plan: Bottom-nav PWA. Dashboard highlights imminent or latest past macro event + real-time Bull/Bear power. Calendar integrates macro data and custom user subscriptions (earnings/events). Intelligence shows AI news feed. Modal for custom event entry ensures seamless user interaction. -->
		<!-- Visualization & Content Choices: Dashboard Hero intelligently selects future or recent past event; Chart.js bar strictly maps real-time aggregated AI news scores; Vanilla JS dynamically merges and sorts Firebase macro + custom collections. -->
		<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
	</head>
	<body
		class="bg-gray-900 text-gray-100 font-sans antialiased flex flex-col h-screen overflow-hidden"
	>
		<header
			class="flex-none bg-gray-900/95 z-40 px-5 pt-safe-top pb-3 border-b border-gray-800"
		>
			<div class="flex justify-between items-end h-12">
				<div>
					<h1 class="font-bold text-xl tracking-tight">
						Market<span class="text-blue-500">Mind</span>
					</h1>
				</div>
				<div class="text-right flex flex-col items-end">
					<div
						id="connection-status"
						class="flex items-center gap-1 text-[10px] text-yellow-500"
					>
						<span class="animate-pulse">â—</span> è¿æ¥ä¸­...
					</div>
					<div
						id="last-update-time"
						class="text-[10px] text-gray-500 font-mono"
					>
						--:--
					</div>
				</div>
			</div>
		</header>

		<main
			class="flex-grow overflow-y-auto hide-scrollbar pb-24 relative"
			id="main-scroll-area"
		>
			<section id="view-dashboard" class="p-5 space-y-6 block">
				<p class="text-xs text-gray-400 mb-2">
					ä¸»å±å¹•ä¸ºæ‚¨æç‚¼å½“ä¸‹æœ€å…·äº¤æ˜“ä»·å€¼çš„ä¿¡å·ã€‚
				</p>

				<div
					id="hero-event-container"
					class="bg-gradient-to-br from-gray-800 to-gray-850 rounded-2xl p-5 border border-gray-700 shadow-xl relative overflow-hidden"
				>
					<div
						class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl -mr-10 -mt-10"
					></div>
					<div
						class="flex justify-between items-start mb-4 relative z-10"
					>
						<div>
							<span
								id="hero-event-type"
								class="text-blue-400 text-xs font-bold tracking-wider uppercase"
								>æ ¸å¿ƒæ•°æ®</span
							>
							<h2
								id="hero-event-title"
								class="text-lg font-bold text-white mt-1"
							>
								åŠ è½½ä¸­...
							</h2>
						</div>
						<div
							id="hero-event-countdown"
							class="bg-gray-900 text-blue-300 px-2 py-1 rounded text-xs font-mono border border-gray-700"
						>
							--:--:--
						</div>
					</div>
					<div class="grid grid-cols-3 gap-3 relative z-10">
						<div class="bg-gray-900/60 p-2 rounded text-center">
							<div class="text-gray-500 text-[10px] uppercase">
								å‰å€¼
							</div>
							<div
								id="hero-event-prev"
								class="text-white font-mono font-bold text-sm"
							>
								--
							</div>
						</div>
						<div
							class="bg-gray-900/60 p-2 rounded text-center border border-blue-500/30"
						>
							<div class="text-blue-400 text-[10px] uppercase">
								é¢„æµ‹
							</div>
							<div
								id="hero-event-fore"
								class="text-blue-400 font-mono font-bold text-sm"
							>
								--
							</div>
						</div>
						<div class="bg-gray-900/60 p-2 rounded text-center">
							<div class="text-gray-500 text-[10px] uppercase">
								å®é™…
							</div>
							<div
								id="hero-event-act"
								class="text-gray-400 font-mono font-bold text-sm"
							>
								--
							</div>
						</div>
					</div>
					<div
						id="hero-event-ai"
						class="mt-3 text-xs text-gray-300 border-t border-gray-700/50 pt-2"
					>
						<span class="text-blue-400 font-bold">AIå‰§æœ¬:</span>
						åŠ è½½ä¸­...
					</div>
				</div>

				<div>
					<div class="flex justify-between items-end mb-3">
						<h3
							class="text-sm font-bold text-gray-300 uppercase tracking-wider"
						>
							å¸‚åœºå¤šç©ºåŠ›é‡ (AIåˆ¤å®š)
						</h3>
					</div>
					<div
						class="bg-gray-800 rounded-xl p-4 border border-gray-700 shadow-lg"
					>
						<div class="chart-container">
							<canvas id="sentimentChart"></canvas>
						</div>
						<p class="text-[10px] text-gray-500 text-center mt-2">
							100% åŸºäºå½“ä¸‹æœ€æ–°çªå‘æ–°é—»çš„ AI è¯„åˆ†èšåˆè®¡ç®—
						</p>
					</div>
				</div>

				<div>
					<div class="flex justify-between items-end mb-3">
						<h3
							class="text-sm font-bold text-gray-300 uppercase tracking-wider"
						>
							æœ€é«˜ä¼˜æƒ…æŠ¥
						</h3>
						<button
							onclick="switchTab('news')"
							class="text-xs text-blue-400 font-medium"
						>
							æŸ¥çœ‹å…¨éƒ¨
						</button>
					</div>
					<div id="dashboard-news-list" class="space-y-3">
						<div class="text-center text-gray-500 text-sm py-4">
							æ­£åœ¨ä»æ•°æ®åº“æ‹‰å–...
						</div>
					</div>
				</div>
			</section>

			<section id="view-calendar" class="p-5 space-y-4 hidden relative">
				<div class="flex justify-between items-center mb-4">
					<p class="text-xs text-gray-400">
						å®è§‚æ•°æ®ä¸ä¸ªäººè®¢é˜…æ—¥ç¨‹åˆå¹¶å±•ç¤º
					</p>
					<button
						onclick="openModal()"
						class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-1.5 px-3 rounded shadow"
					>
						â• è®¢é˜…äº‹ä»¶
					</button>
				</div>
				<div id="calendar-list" class="space-y-3"></div>
			</section>

			<section
				id="view-news"
				class="p-5 space-y-4 hidden flex flex-col h-full"
			>
				<p class="text-xs text-gray-400 mb-2">
					ç»è¿‡ AI ä¸¥æ ¼ç­›é€‰çš„çªå‘é«˜ä»·å€¼å¸‚åœºæƒ…æŠ¥ï¼Œè¯„åˆ† 7
					åˆ†ä»¥ä¸Šäºˆä»¥å±•ç¤ºã€‚
				</p>
				<div class="flex gap-2 mb-2">
					<button
						onclick="filterNews('all')"
						id="filter-all"
						class="filter-btn px-3 py-1 rounded-full text-xs font-medium bg-blue-600 text-white border-transparent"
					>
						å…¨éƒ¨
					</button>
					<button
						onclick="filterNews('bull')"
						id="filter-bull"
						class="filter-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700"
					>
						çœ‹å¤š
					</button>
					<button
						onclick="filterNews('bear')"
						id="filter-bear"
						class="filter-btn px-3 py-1 rounded-full text-xs font-medium bg-gray-800 text-gray-400 border border-gray-700"
					>
						çœ‹ç©º
					</button>
				</div>
				<div id="intelligence-list" class="space-y-4 pb-10"></div>
			</section>

			<section
				id="view-error"
				class="p-5 h-full flex flex-col items-center justify-center hidden"
			>
				<div class="text-4xl mb-4">âš ï¸</div>
				<h2 class="text-xl font-bold text-yellow-500 mb-2">
					æ•°æ®åº“å°šæœªåˆå§‹åŒ–
				</h2>
				<p class="text-gray-300 text-sm mb-6 text-center">
					é…ç½®å·²ç”Ÿæ•ˆï¼Œä½†ä½ çš„é¡¹ç›®éœ€è¦åœ¨ç½‘é¡µç«¯åˆ›å»ºä¸€æ¬¡æ•°æ®åº“å®ä¾‹ã€‚
				</p>
				<div
					class="bg-gray-800 p-5 rounded-xl text-xs text-gray-300 w-full max-w-sm border border-gray-700"
				>
					<ol class="list-decimal ml-4 space-y-2">
						<li>å‰å¾€ Firebase æ§åˆ¶å° -> Firestore Database</li>
						<li>ç‚¹å‡» Create databaseï¼Œä½ç½®é€‰ Singapore</li>
						<li>è§„åˆ™é€‰ Start in test modeï¼Œç„¶ååˆ·æ–°æœ¬é¡µ</li>
					</ol>
				</div>
			</section>
		</main>

		<nav class="fixed bottom-0 w-full glass-nav z-40 pb-safe">
			<div class="flex justify-around items-center h-16 px-2">
				<button
					onclick="switchTab('dashboard')"
					id="tab-dashboard"
					class="nav-tab flex flex-col items-center justify-center w-full h-full text-blue-500 transition-colors"
				>
					<span class="text-xl mb-1">ğŸ“ˆ</span
					><span class="text-[10px] font-bold">æ¦‚è§ˆ</span>
				</button>
				<button
					onclick="switchTab('calendar')"
					id="tab-calendar"
					class="nav-tab flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-300 transition-colors"
				>
					<span class="text-xl mb-1">ğŸ“…</span
					><span class="text-[10px] font-medium">æ—¥å†</span>
				</button>
				<button
					onclick="switchTab('news')"
					id="tab-news"
					class="nav-tab flex flex-col items-center justify-center w-full h-full text-gray-500 hover:text-gray-300 transition-colors"
				>
					<span class="text-xl mb-1">ğŸ§ </span
					><span class="text-[10px] font-medium">æƒ…æŠ¥</span>
				</button>
			</div>
		</nav>

		<div
			id="event-modal"
			class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4"
		>
			<div
				class="bg-gray-800 rounded-2xl border border-gray-700 w-full max-w-sm p-5 shadow-2xl transform transition-all"
			>
				<h3 class="text-lg font-bold text-white mb-4">
					æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ / è´¢æŠ¥
				</h3>
				<div class="space-y-4">
					<div>
						<label class="block text-xs text-gray-400 mb-1"
							>è‚¡ç¥¨ä»£ç  / äº‹ä»¶åç§°</label
						><input
							type="text"
							id="ev-title"
							placeholder="å¦‚: NVDA è´¢æŠ¥"
							class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"
						/>
					</div>
					<div>
						<label class="block text-xs text-gray-400 mb-1"
							>æ—¥æœŸæ—¶é—´</label
						><input
							type="datetime-local"
							id="ev-date"
							class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"
						/>
					</div>
					<div>
						<label class="block text-xs text-gray-400 mb-1"
							>å¤‡æ³¨è¯´æ˜</label
						><input
							type="text"
							id="ev-note"
							placeholder="å¦‚: ç›˜åå‘å¸ƒï¼ŒIV æé«˜"
							class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-white text-sm focus:border-blue-500 outline-none"
						/>
					</div>
				</div>
				<div class="mt-6 flex gap-3 justify-end">
					<button
						onclick="closeModal()"
						class="px-4 py-2 rounded text-sm text-gray-400 hover:text-white"
					>
						å–æ¶ˆ
					</button>
					<button
						onclick="saveCustomEvent()"
						class="px-4 py-2 rounded text-sm bg-blue-600 hover:bg-blue-500 text-white font-bold"
					>
						ä¿å­˜è®¢é˜…
					</button>
				</div>
			</div>
		</div>

		<script>
			// è¯·åœ¨æ­¤å¤„å¡«å…¥ä½ çš„é…ç½®ä¿¡æ¯
			const firebaseConfig = {
				apiKey: "AIzaSyAHnFy-RQTrJRIu4BFF4LnGA_PP6GWSDsk",
				authDomain: "finance-app-447cc.firebaseapp.com",
				projectId: "finance-app-447cc",
				storageBucket: "finance-app-447cc.firebasestorage.app",
				messagingSenderId: "453168549752",
				appId: "1:453168549752:web:f8df55083f2aeb30c4028d",
				measurementId: "G-ZM5V2VNLZR",
			};

			let db;
			try {
				if (!firebase.apps.length)
					firebase.initializeApp(firebaseConfig);
				db = firebase.firestore();
			} catch (e) {
				showErrorState();
			}

			const state = {
				macroData: [],
				newsData: [],
				customData: [],
				currentTab: "dashboard",
				currentNewsFilter: "all",
				nextEventTimer: null,
				sentimentChart: null,
			};

			function initDataListeners() {
				const statusEl = document.getElementById("connection-status");
				const timeEl = document.getElementById("last-update-time");
				if (!db) return;

				const handleErr = (e, unsub) => {
					if (e.code === "not-found") {
						showErrorState();
						if (unsub) unsub();
					}
				};

				let unsubM = db
					.collection("market_data")
					.doc("macro")
					.onSnapshot(
						(doc) => {
							if (doc.exists) {
								state.macroData = doc.data().events || [];
								timeEl.innerText = doc.data().last_updated
									? doc.data().last_updated.split(" ")[1]
									: "--:--";
								statusEl.innerHTML =
									'<span class="text-green-500">â—</span> å·²åŒæ­¥';
								statusEl.className =
									"flex items-center gap-1 text-[10px] text-gray-400";
								updateUI();
							}
						},
						(e) => handleErr(e, unsubM),
					);

				let unsubN = db
					.collection("market_data")
					.doc("news")
					.onSnapshot(
						(doc) => {
							if (doc.exists) {
								state.newsData = doc.data().articles || [];
								updateUI();
							}
						},
						(e) => handleErr(e, unsubN),
					);

				let unsubC = db
					.collection("market_data")
					.doc("custom_calendar")
					.onSnapshot(
						(doc) => {
							if (doc.exists) {
								state.customData = doc.data().events || [];
								updateUI();
							}
						},
						(e) => handleErr(e, unsubC),
					);
			}

			function showErrorState() {
				["view-dashboard", "view-calendar", "view-news"].forEach((id) =>
					document.getElementById(id).classList.add("hidden"),
				);
				document
					.getElementById("view-error")
					.classList.remove("hidden");
				document.getElementById("connection-status").innerHTML =
					'<span class="text-red-500">â—</span> è¿æ¥å¤±è´¥';
			}

			function updateUI() {
				renderDashboardHero();
				renderDashboardNews();
				renderCalendar();
				renderIntelligenceNews();
				updateSentimentChart();
			}

			function renderDashboardHero() {
				if (!state.macroData.length) {
					document.getElementById("hero-event-title").innerText =
						"æš‚æ— æ•°æ®";
					return;
				}
				const now = new Date().getTime() / 1000;
				let targetEvent = state.macroData.find(
					(e) => e.timestamp > now,
				);
				let isPast = false;
				if (!targetEvent) {
					targetEvent = state.macroData[state.macroData.length - 1];
					isPast = true;
				}

				document.getElementById("hero-event-title").innerText =
					targetEvent.title;
				document.getElementById("hero-event-prev").innerText =
					targetEvent.previous || "--";
				document.getElementById("hero-event-fore").innerText =
					targetEvent.forecast || "--";
				document.getElementById("hero-event-act").innerText =
					targetEvent.actual || "--";
				document.getElementById("hero-event-ai").innerHTML =
					`<span class="text-blue-400 font-bold">AIè§£è¯»:</span> ${targetEvent.analysis || "æš‚æ— è¯¦ç»†åˆ†æ"}`;

				const cEl = document.getElementById("hero-event-countdown");
				const typeEl = document.getElementById("hero-event-type");
				if (state.nextEventTimer) clearInterval(state.nextEventTimer);

				if (isPast) {
					typeEl.innerText = "æœ€æ–°å·²å…¬å¸ƒæ•°æ®";
					cEl.innerText = "å·²å…¬å¸ƒ";
					cEl.className =
						"bg-gray-800 text-gray-400 px-2 py-1 rounded text-xs font-mono border border-gray-700";
				} else {
					typeEl.innerText = "å³å°†å…¬å¸ƒæ ¸å¿ƒæ•°æ®";
					state.nextEventTimer = setInterval(() => {
						const diff =
							targetEvent.timestamp - new Date().getTime() / 1000;
						if (diff <= 0) {
							cEl.innerText = "æ­£åœ¨å…¬å¸ƒ!";
							cEl.className =
								"bg-red-600 text-white px-2 py-1 rounded text-xs font-mono font-bold animate-pulse";
							clearInterval(state.nextEventTimer);
							return;
						}
						const h = Math.floor(diff / 3600)
								.toString()
								.padStart(2, "0"),
							m = Math.floor((diff % 3600) / 60)
								.toString()
								.padStart(2, "0"),
							s = Math.floor(diff % 60)
								.toString()
								.padStart(2, "0");
						cEl.innerText = `T-${h}:${m}:${s}`;
						cEl.className =
							diff < 1800
								? "bg-yellow-600/20 text-yellow-400 border-yellow-600/50 px-2 py-1 rounded text-xs font-mono"
								: "bg-gray-900 text-blue-300 px-2 py-1 rounded text-xs font-mono border border-gray-700";
					}, 1000);
				}
			}

			function generateNewsCardHTML(news) {
				const isBull = news.impact.includes("å¤š"),
					isBear = news.impact.includes("ç©º");
				const impactColor = isBull
					? "text-green-400 bg-green-400/10 border-green-400/30"
					: isBear
						? "text-red-400 bg-red-400/10 border-red-400/30"
						: "text-gray-400 bg-gray-400/10 border-gray-400/30";
				const scoreColor =
					news.score >= 9
						? "bg-red-600 text-white"
						: "bg-gray-700 text-gray-300";
				return `<div class="bg-gray-800 rounded-xl p-4 border border-gray-700 relative overflow-hidden shadow-sm">
                <div class="absolute top-0 right-0 px-2 py-1 text-[10px] font-bold rounded-bl-lg ${scoreColor}">${news.score} / 10</div>
                <h4 class="text-white font-medium text-sm pr-10 leading-snug mb-3">${news.title}</h4>
                <div class="flex gap-2 items-start flex-col sm:flex-row sm:items-center">
                    <span class="px-2 py-1 rounded border text-[10px] font-bold ${impactColor}">${news.impact}</span>
                    <p class="text-gray-400 text-xs flex-1 line-clamp-2"><span class="text-gray-300 font-bold">ç®€è¯„:</span> ${news.reason}</p>
                </div></div>`;
			}

			function renderDashboardNews() {
				const container = document.getElementById(
					"dashboard-news-list",
				);
				if (!state.newsData.length) {
					container.innerHTML =
						'<div class="text-center text-gray-500 text-sm py-4">å½“å‰æ— é‡å¤§å¸‚åœºå¼‚åŠ¨</div>';
					return;
				}
				container.innerHTML = [...state.newsData]
					.sort((a, b) => b.score - a.score)
					.slice(0, 3)
					.map((n) => generateNewsCardHTML(n))
					.join("");
			}

			function renderCalendar() {
				const container = document.getElementById("calendar-list");
				const combined = [...state.macroData, ...state.customData].sort(
					(a, b) => a.timestamp - b.timestamp,
				);
				if (!combined.length) {
					container.innerHTML =
						'<div class="text-center text-gray-500 text-sm py-10">å½“å‰æ— ä»»ä½•æ—¥ç¨‹</div>';
					return;
				}

				const now = new Date().getTime() / 1000;
				container.innerHTML = combined
					.map((ev) => {
						const isCustom = ev.type === "custom";
						const isPast = ev.timestamp < now;
						const dateParts = ev.date.split(" ");
						const day = dateParts[0] ? dateParts[0].slice(5) : "--";
						const time = dateParts[1] ? dateParts[1] : "--";
						const opacity = isPast ? "opacity-50 grayscale" : "";
						const badge = isCustom
							? `<span class="bg-blue-900/50 text-blue-400 border border-blue-800 px-1 rounded text-[8px] uppercase ml-2">è‡ªé€‰è®¢é˜…</span>`
							: "";
						const details = isCustom
							? `<span class="text-blue-300">å¤‡æ³¨: ${ev.forecast || "--"}</span>`
							: `<span>å‰: ${ev.previous || "--"}</span><span class="text-blue-400">é¢„: ${ev.forecast || "--"}</span>`;

						return `<div class="flex gap-3 bg-gray-800/50 p-3 rounded-xl border border-gray-700 items-center ${opacity}">
                    <div class="flex flex-col items-center justify-center min-w-[50px] bg-gray-900 rounded-lg h-[50px] border border-gray-700 shadow-inner">
                        <span class="text-[10px] text-gray-500">${day}</span><span class="text-xs font-bold text-gray-300">${time}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-gray-200 truncate">${ev.title}${badge}</h4>
                        <div class="flex gap-3 mt-1 text-[10px] text-gray-400">${details}</div>
                    </div>
                </div>`;
					})
					.join("");
			}

			function renderIntelligenceNews() {
				const container = document.getElementById("intelligence-list");
				let filtered = state.newsData || [];
				if (state.currentNewsFilter === "bull")
					filtered = filtered.filter((n) => n.impact.includes("å¤š"));
				else if (state.currentNewsFilter === "bear")
					filtered = filtered.filter((n) => n.impact.includes("ç©º"));
				filtered.sort((a, b) => b.score - a.score);
				container.innerHTML = filtered.length
					? filtered.map((n) => generateNewsCardHTML(n)).join("")
					: '<div class="text-center text-gray-500 text-sm py-10 border border-dashed border-gray-700 rounded-xl">æ— ç¬¦åˆæ¡ä»¶çš„æƒ…æŠ¥</div>';
			}

			function updateSentimentChart() {
				const ctx = document
					.getElementById("sentimentChart")
					.getContext("2d");
				let bullPower = 0.1,
					bearPower = 0.1;
				if (state.newsData.length) {
					bullPower = 0;
					bearPower = 0;
					state.newsData.forEach((n) => {
						if (n.impact.includes("å¤š")) bullPower += n.score;
						if (n.impact.includes("ç©º")) bearPower += n.score;
					});
				}
				if (state.sentimentChart) {
					state.sentimentChart.data.datasets[0].data = [
						bullPower,
						bearPower,
					];
					state.sentimentChart.update();
					return;
				}
				Chart.defaults.color = "#9CA3AF";
				Chart.defaults.font.family = "'Inter', sans-serif";
				state.sentimentChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: ["çœ‹å¤š (Bull)", "çœ‹ç©º (Bear)"],
						datasets: [
							{
								data: [bullPower, bearPower],
								backgroundColor: [
									"rgba(16, 185, 129, 0.8)",
									"rgba(239, 68, 68, 0.8)",
								],
								borderColor: ["#10B981", "#EF4444"],
								borderWidth: 1,
								borderRadius: 4,
								barThickness: 20,
							},
						],
					},
					options: {
						indexAxis: "y",
						responsive: true,
						maintainAspectRatio: false,
						plugins: {
							legend: { display: false },
							tooltip: {
								backgroundColor: "rgba(17, 24, 39, 0.95)",
								titleColor: "#fff",
								bodyColor: "#e5e7eb",
								borderColor: "#374151",
								borderWidth: 1,
								padding: 10,
								callbacks: {
									label: (c) =>
										` å¼ºåº¦: ${c.parsed.x.toFixed(1)} åˆ†`,
								},
							},
						},
						scales: {
							x: {
								grid: {
									color: "rgba(55, 65, 81, 0.3)",
									borderDash: [5, 5],
								},
								beginAtZero: true,
								title: {
									display: true,
									text: "ç´¯è®¡è¯„åˆ† (Score)",
									font: { size: 10 },
								},
							},
							y: {
								grid: { display: false, drawBorder: false },
								ticks: {
									font: { size: 12, weight: "bold" },
									color: "#D1D5DB",
								},
							},
						},
					},
				});
			}

			function switchTab(tabId) {
				state.currentTab = tabId;
				[
					"view-dashboard",
					"view-calendar",
					"view-news",
					"view-error",
				].forEach((id) =>
					document.getElementById(id).classList.add("hidden"),
				);
				document
					.getElementById(`view-${tabId}`)
					.classList.remove("hidden");
				["dashboard", "calendar", "news"].forEach((t) => {
					const btn = document.getElementById(`tab-${t}`);
					if (t === tabId) {
						btn.classList.remove(
							"text-gray-500",
							"hover:text-gray-300",
						);
						btn.classList.add("text-blue-500");
						btn.querySelector(
							"span:nth-child(2)",
						).classList.replace("font-medium", "font-bold");
					} else {
						btn.classList.remove("text-blue-500");
						btn.classList.add(
							"text-gray-500",
							"hover:text-gray-300",
						);
						btn.querySelector(
							"span:nth-child(2)",
						).classList.replace("font-bold", "font-medium");
					}
				});
				document.getElementById("main-scroll-area").scrollTop = 0;
			}

			function filterNews(type) {
				state.currentNewsFilter = type;
				["all", "bull", "bear"].forEach((b) => {
					const el = document.getElementById(`filter-${b}`);
					if (b === type) {
						el.classList.remove(
							"bg-gray-800",
							"text-gray-400",
							"border-gray-700",
						);
						el.classList.add(
							"bg-blue-600",
							"text-white",
							"border-transparent",
						);
					} else {
						el.classList.remove(
							"bg-blue-600",
							"text-white",
							"border-transparent",
						);
						el.classList.add(
							"bg-gray-800",
							"text-gray-400",
							"border-gray-700",
						);
					}
				});
				renderIntelligenceNews();
			}

			function openModal() {
				document
					.getElementById("event-modal")
					.classList.remove("hidden");
			}
			function closeModal() {
				document.getElementById("event-modal").classList.add("hidden");
				document.getElementById("ev-title").value = "";
				document.getElementById("ev-date").value = "";
				document.getElementById("ev-note").value = "";
			}

			async function saveCustomEvent() {
				if (!db) return alert("æ•°æ®åº“æœªè¿æ¥");
				const title = document.getElementById("ev-title").value;
				const dtVal = document.getElementById("ev-date").value;
				const note = document.getElementById("ev-note").value;
				if (!title || !dtVal) return alert("è¯·å¡«å†™åç§°å’Œæ—¥æœŸæ—¶é—´");

				const dt = new Date(dtVal);
				const newEvent = {
					title: title,
					date: `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, "0")}-${String(dt.getDate()).padStart(2, "0")} ${String(dt.getHours()).padStart(2, "0")}:${String(dt.getMinutes()).padStart(2, "0")} (SGT)`,
					timestamp: dt.getTime() / 1000,
					type: "custom",
					forecast: note,
					previous: "",
					actual: "",
					analysis: "",
				};

				const docRef = db
					.collection("market_data")
					.doc("custom_calendar");
				try {
					await docRef.set(
						{
							events: firebase.firestore.FieldValue.arrayUnion(
								newEvent,
							),
						},
						{ merge: true },
					);
					closeModal();
				} catch (e) {
					alert("ä¿å­˜å¤±è´¥: " + e.message);
				}
			}

			document.addEventListener("DOMContentLoaded", () => {
				initDataListeners();
				updateSentimentChart();
			});
		</script>
	</body>
</html>
